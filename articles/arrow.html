<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="mtgr">
<title>Handling large datasets with arrow • mtgr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Handling large datasets with arrow">
<meta property="og:description" content="mtgr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mtgr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/download-cache.html">Downloading files and using the cache</a>
    <a class="dropdown-item" href="../articles/arrow.html">Handling large datasets with arrow</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Handling large datasets with arrow</h1>
            
      
      
      <div class="d-none name"><code>arrow.Rmd</code></div>
    </div>

    
    
<p>The <a href="https://17lands.com" class="external-link">17lands</a> datasets all tend to be
large, but the game replay datasets in particular are so large that they
often cannot be loaded into R (depending on your computer’s memory).</p>
<p>Fortunately, the <a href="https://arrow.apache.org/docs/r/" class="external-link">{arrow} R
package</a> can work with <em>external</em> data files, so we can use it
to analyze the game replay data, with the help of some
<code>magicr</code> functions. This vignettes shows how.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://joelnitta.github.io/mtgr/" class="external-link">mtgr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/" class="external-link">arrow</a></span><span class="op">)</span></span>
<span><span class="co"># you could also just do library(tidyverse) for the next three</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="get-the-data">Get the data<a class="anchor" aria-label="anchor" href="#get-the-data"></a>
</h2>
<p>First, let’s download a dataset of game replay data to analyze. Here,
we’ll download <em>Khans of Tarkir</em>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ktk_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mr_download_17lands_file.html">mr_download_17lands_file</a></span><span class="op">(</span></span>
<span>  set <span class="op">=</span> <span class="st">"WOE"</span>, data_type <span class="op">=</span> <span class="st">"replay"</span>, event_type <span class="op">=</span> <span class="st">"premier"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Starting download</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Data downloaded to <span style="color: #0000BB;">/home/runner/.local/share/R/mtgr/replay_data_public.WOE.PremierDraft.csv.gz</span></span></span></code></pre></div>
<p>The file is automatically downloaded to the cache (see
<code><a href="../articles/download-cache.html">vignette("download-cache")</a></code> for more details).</p>
<p>Let’s check the location and size of the file we just downloaded:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ktk_file</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000; font-weight: bold;">/home/runner/.local/share/R/mtgr/replay_data_public.WOE.PremierDraft.csv.gz</span></span></span>
<span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_info.html" class="external-link">file_size</a></span><span class="op">(</span><span class="va">ktk_file</span><span class="op">)</span></span>
<span><span class="co">#&gt; 556M</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="open-the-dataset">Open the dataset<a class="anchor" aria-label="anchor" href="#open-the-dataset"></a>
</h2>
<p>Next, we will <em>open</em> the dataset.</p>
<p>..notice I did <strong>not</strong> say “load”! This is an important
distinction when using {arrow}: <em>opening</em> a dataset means that we
are establishing a connection to the external file, but we are not
actually loading it into R.</p>
<p>To open a 17lands game-replay file, use
<code><a href="../reference/mr_open_17lands_arrow.html">mr_open_17lands_arrow()</a></code> with the same settings as you did
above for <code><a href="../reference/mr_download_17lands_file.html">mr_download_17lands_file()</a></code> (actually,
<code><a href="../reference/mr_open_17lands_arrow.html">mr_open_17lands_arrow()</a></code> will download the file
automatically if it’s not there yet, so we could have skipped the
previous step; that was just to illustrate where the file gets saved and
to check the file size).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ktk_replay_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mr_open_17lands_arrow.html">mr_open_17lands_arrow</a></span><span class="op">(</span><span class="st">"KTK"</span>, <span class="st">"replay"</span>, <span class="st">"premier"</span><span class="op">)</span></span></code></pre></div>
<p>If you check the results of <code><a href="../reference/mr_open_17lands_arrow.html">mr_open_17lands_arrow()</a></code> by
typing <code>ktk_replay_data</code> directly, you will get a very long
list of column names and their corresponding data types, called “schema”
in {arrow} parlance (here I have truncated the output to only first
20).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ktk_replay_data</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; FileSystemDataset with 1 csv file</span></span>
<span><span class="co">#&gt; expansion: string</span></span>
<span><span class="co">#&gt; event_type: string</span></span>
<span><span class="co">#&gt; draft_id: string</span></span>
<span><span class="co">#&gt; draft_time: string</span></span>
<span><span class="co">#&gt; build_index: int8</span></span>
<span><span class="co">#&gt; match_number: int8</span></span>
<span><span class="co">#&gt; game_number: int8</span></span>
<span><span class="co">#&gt; game_time: string</span></span>
<span><span class="co">#&gt; rank: string</span></span>
<span><span class="co">#&gt; opp_rank: string</span></span>
<span><span class="co">#&gt; main_colors: string</span></span>
<span><span class="co">#&gt; splash_colors: string</span></span>
<span><span class="co">#&gt; on_play: bool</span></span>
<span><span class="co">#&gt; num_mulligans: int8</span></span>
<span><span class="co">#&gt; opp_num_mulligans: int8</span></span>
<span><span class="co">#&gt; opp_colors: string</span></span>
<span><span class="co">#&gt; num_turns: int8</span></span>
<span><span class="co">#&gt; won: string</span></span>
<span><span class="co">#&gt; candidate_hand_1: string</span></span></code></pre>
<p>Once again, the reason that we see a schema and not the actual data
is that we have not loaded the data into R yet, we have only made a
connection to the file.</p>
<p>We can check the dimensions of the dataset without reading it in, by
using <code><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim()</a></code> as usual:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">ktk_replay_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 212170   2505</span></span></code></pre></div>
<p>That is pretty big: 212,170 rows by 2,505 columns (and KTK isn’t even
that big; last I checked, WOE had &gt;1 million rows). The reason the
game data are so large is that each row is a single game, and the
columns account for every action taken on every turn. I don’t have the
time to go into the details here, but suffice to say there are a lot of
columns.</p>
</div>
<div class="section level2">
<h2 id="analyze-the-data">Analyze the data<a class="anchor" aria-label="anchor" href="#analyze-the-data"></a>
</h2>
<p>OK, now that we have opened the dataset, it’s finally time to do
something with it!</p>
<p>For demonstration purposes, let’s use the dataset to analyze the
<strong>win-rate of cards in the user’s opening hand</strong>.</p>
<p>First, let’s make a vector of columns that we are interested in to
subset the data:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Columns we are interested in:</span></span>
<span><span class="co"># - whether the user won or or not</span></span>
<span><span class="co"># - all the columns that tell us what they had in their opening hand</span></span>
<span><span class="co">#   (including tutored cards, but that seems pretty unlikely!)</span></span>
<span><span class="va">turn_1_card_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="co"># "draft_time",</span></span>
<span>  <span class="st">"won"</span>,</span>
<span>  <span class="st">"user_turn_1_cards_drawn"</span>,</span>
<span>  <span class="st">"user_turn_1_cards_tutored"</span>,</span>
<span>  <span class="st">"user_turn_1_creatures_cast"</span>,</span>
<span>  <span class="st">"user_turn_1_eot_user_cards_in_hand"</span>,</span>
<span>  <span class="st">"user_turn_1_lands_played"</span>,</span>
<span>  <span class="st">"user_turn_1_non_creatures_cast"</span><span class="op">)</span></span></code></pre></div>
<p>Next, use <code>dplyr</code>-like syntax to subset to only the
columns we are interested in from the data (the <code><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select()</a></code>
function), and combine this with <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect()</a></code> from
<a href="https://github.com/apache/arrow/" class="external-link">arrow</a>. That last step is different from normal
<code>dplyr</code> pipelines: <a href="https://github.com/apache/arrow/" class="external-link">arrow</a> will hold off on
doing any actual calculations on the data until you tell it to do so
with <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect()</a></code>. That is what enables it to handle large,
out-of-memory datasets.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ktk_turn_1</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">ktk_replay_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">won</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">turn_1_card_cols</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The output of <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect()</a></code> is a dataframe (tibble). This is
<strong>much smaller</strong> than the original replay dataframe, so we
will have no problem working with it in R as usual.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ktk_turn_1</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 212,170 × 7</span></span></span>
<span><span class="co">#&gt;    won   user_turn_1_cards_drawn user_turn_1_cards_tuto…¹ user_turn_1_creature…²</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> True  <span style="color: #BB0000;">NA</span>                      <span style="color: #BB0000;">NA</span>                       <span style="color: #BB0000;">NA</span>                    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> True  58033                   <span style="color: #BB0000;">NA</span>                       <span style="color: #BB0000;">NA</span>                    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> False <span style="color: #BB0000;">NA</span>                      <span style="color: #BB0000;">NA</span>                       <span style="color: #BB0000;">NA</span>                    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> False 58183                   <span style="color: #BB0000;">NA</span>                       <span style="color: #BB0000;">NA</span>                    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> True  90190                   <span style="color: #BB0000;">NA</span>                       <span style="color: #BB0000;">NA</span>                    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> False 58145                   <span style="color: #BB0000;">NA</span>                       <span style="color: #BB0000;">NA</span>                    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> False <span style="color: #BB0000;">NA</span>                      <span style="color: #BB0000;">NA</span>                       57959                 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> False 58423                   <span style="color: #BB0000;">NA</span>                       <span style="color: #BB0000;">NA</span>                    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> False 57939                   <span style="color: #BB0000;">NA</span>                       57959                 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> True  58409                   <span style="color: #BB0000;">NA</span>                       <span style="color: #BB0000;">NA</span>                    </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 212,160 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ abbreviated names: ¹​user_turn_1_cards_tutored, ²​user_turn_1_creatures_cast</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 3 more variables: user_turn_1_eot_user_cards_in_hand &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   user_turn_1_lands_played &lt;chr&gt;, user_turn_1_non_creatures_cast &lt;chr&gt;</span></span></span></code></pre></div>
<p>In general, you typically don’t need <em>all</em> the columns for a
given analysis; you should be able to use this approach to only subset
to those you’re interested in, then work with the data as a dataframe
from there.</p>
<p>The following code sets a threshold of number of games played for
each card (in other words, dropping cards with insufficient data), then
calculates the win-rate per card in the opening hand. None of this uses
<a href="https://github.com/apache/arrow/" class="external-link">arrow</a>, since we are now working with an in-memory
dataframe. It’s just good-old <code>tidyverse</code>-style data
wrangling.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate the cutoff value (.25% of the total number of rows)</span></span>
<span><span class="co"># to exclude cards that have insufficient data</span></span>
<span><span class="va">cutoff_value</span> <span class="op">&lt;-</span> <span class="fl">0.0025</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">ktk_turn_1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ktk_opening_hand_wr</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">ktk_turn_1</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">ktk_turn_1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>names_to <span class="op">=</span> <span class="st">"what"</span>, values_to <span class="op">=</span> <span class="st">"card"</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">won</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">card</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">won</span>, <span class="va">card</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate_longer_delim.html" class="external-link">separate_longer_delim</a></span><span class="op">(</span><span class="va">card</span>, delim <span class="op">=</span> <span class="st">"|"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    won <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">won</span><span class="op">)</span>,</span>
<span>    card <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">card</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">card</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>    n_win <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">won</span><span class="op">)</span>,</span>
<span>    n_total <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html" class="external-link">n_distinct</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">n_total</span> <span class="op">&gt;</span> <span class="va">cutoff_value</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>win_rate <span class="op">=</span> <span class="va">n_win</span> <span class="op">/</span> <span class="va">n_total</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">win_rate</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ktk_opening_hand_wr</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 352 × 4</span></span></span>
<span><span class="co">#&gt;     card n_win n_total win_rate</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> <span style="text-decoration: underline;">58</span>263   564     874    0.645</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> <span style="text-decoration: underline;">84</span>596   381     591    0.645</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> <span style="text-decoration: underline;">57</span>999   661    <span style="text-decoration: underline;">1</span>039    0.636</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> <span style="text-decoration: underline;">57</span>961  <span style="text-decoration: underline;">1</span>357    <span style="text-decoration: underline;">2</span>139    0.634</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> <span style="text-decoration: underline;">58</span>135   589     935    0.630</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> <span style="text-decoration: underline;">57</span>981  <span style="text-decoration: underline;">3</span>378    <span style="text-decoration: underline;">5</span>367    0.629</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> <span style="text-decoration: underline;">58</span>275  <span style="text-decoration: underline;">2</span>983    <span style="text-decoration: underline;">4</span>767    0.626</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> <span style="text-decoration: underline;">58</span>331   936    <span style="text-decoration: underline;">1</span>496    0.626</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> <span style="text-decoration: underline;">57</span>963  <span style="text-decoration: underline;">1</span>353    <span style="text-decoration: underline;">2</span>164    0.625</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> <span style="text-decoration: underline;">58</span>305   982    <span style="text-decoration: underline;">1</span>575    0.623</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 342 more rows</span></span></span></code></pre></div>
<p>There’s one last detail: the cards are labeled with a code (ID
number), not their actual names!</p>
<p>Fortunately, 17lands provides a dataset that links these card IDs to
actual card names:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">card_names</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="st">"https://17lands-public.s3.amazonaws.com/analysis_data/cards/cards.csv"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Rows: </span><span style="color: #0000BB;">15145</span> <span style="font-weight: bold;">Columns: </span><span style="color: #0000BB;">8</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Column specification</span> <span style="color: #00BBBB;">────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Delimiter:</span> ","</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">chr</span> (5): expansion, name, rarity, color_identity, types</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">dbl</span> (2): id, mana_value</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">lgl</span> (1): is_booster</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Use `spec()` to retrieve the full column specification for this data.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Specify the column types or set `show_col_types = FALSE` to quiet this message.</span></span>
<span></span>
<span><span class="va">card_names</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 15,145 × 8</span></span></span>
<span><span class="co">#&gt;       id expansion name        rarity color_identity mana_value types is_booster</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> <span style="text-decoration: underline;">65</span>591 HOU       Ammit Eter… rare   B                       3 Crea… TRUE      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> <span style="text-decoration: underline;">65</span>633 HOU       Torment of… uncom… B                       4 Ench… TRUE      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> <span style="text-decoration: underline;">32</span>925 M10       Merfolk Lo… common U                       2 Crea… TRUE      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> <span style="text-decoration: underline;">32</span>951 M10       Ornithopter uncom… <span style="color: #BB0000;">NA</span>                      0 Arti… TRUE      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> <span style="text-decoration: underline;">33</span>035 M10       Platinum A… mythic <span style="color: #BB0000;">NA</span>                      7 Arti… TRUE      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> <span style="text-decoration: underline;">33</span>069 M10       Hypnotic S… rare   B                       3 Crea… TRUE      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> <span style="text-decoration: underline;">65</span>961 XLN       Adanto Van… uncom… W                       2 Crea… TRUE      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> <span style="text-decoration: underline;">65</span>963 XLN       Ashes of t… rare   W                       2 Ench… TRUE      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> <span style="text-decoration: underline;">65</span>965 XLN       Axis of Mo… mythic W                       6 Ench… TRUE      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> <span style="text-decoration: underline;">65</span>967 XLN       Bellowing … uncom… W                       6 Crea… TRUE      </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 15,135 more rows</span></span></span></code></pre></div>
<p>Let’s do a join operation to go from card ID to card name and drop
basic lands:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ktk_opening_hand_wr</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">card_names</span>, card <span class="op">=</span> <span class="va">id</span>, <span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Swamp"</span>, <span class="st">"Plains"</span>, <span class="st">"Island"</span>, <span class="st">"Mountain"</span>, <span class="st">"Forest"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(card)`</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 224 × 5</span></span></span>
<span><span class="co">#&gt;     card n_win n_total win_rate name                     </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> <span style="text-decoration: underline;">58</span>263   564     874    0.645 Anafenza, the Foremost   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> <span style="text-decoration: underline;">57</span>999   661    <span style="text-decoration: underline;">1</span>039    0.636 Wingmate Roc             </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> <span style="text-decoration: underline;">57</span>961  <span style="text-decoration: underline;">1</span>357    <span style="text-decoration: underline;">2</span>139    0.634 Herald of Anafenza       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> <span style="text-decoration: underline;">58</span>135   589     935    0.630 Ashcloud Phoenix         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> <span style="text-decoration: underline;">57</span>981  <span style="text-decoration: underline;">3</span>378    <span style="text-decoration: underline;">5</span>367    0.629 Seeker of the Way        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> <span style="text-decoration: underline;">58</span>275  <span style="text-decoration: underline;">2</span>983    <span style="text-decoration: underline;">4</span>767    0.626 Chief of the Edge        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> <span style="text-decoration: underline;">58</span>331   936    <span style="text-decoration: underline;">1</span>496    0.626 Savage Knuckleblade      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> <span style="text-decoration: underline;">57</span>963  <span style="text-decoration: underline;">1</span>353    <span style="text-decoration: underline;">2</span>164    0.625 High Sentinels of Arashin</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> <span style="text-decoration: underline;">58</span>305   982    <span style="text-decoration: underline;">1</span>575    0.623 Mantis Rider             </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> <span style="text-decoration: underline;">58</span>329  <span style="text-decoration: underline;">1</span>195    <span style="text-decoration: underline;">1</span>917    0.623 Sagu Mauler              </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 214 more rows</span></span></span></code></pre></div>
<p>You can verify that this matches up with the opening-hand win-rate
(<code>OH WR</code>) available in the<a href="https://www.17lands.com/card_data?expansion=KTK&amp;format=PremierDraft&amp;start=2014-09-26&amp;columns=opening&amp;sort=opening_hand_win_rate%2Cdesc" class="external-link">17lands
card data</a> (exact numbers will vary because the public dataset
doesn’t include exactly the same dataset as that used to calculate the
stats available on the card stats page; I recommend filtering the data
by date to help with this).</p>
</div>
<div class="section level2">
<h2 id="wrap-up">Wrap-up<a class="anchor" aria-label="anchor" href="#wrap-up"></a>
</h2>
<p>This vignette showed how you can analyze very large MtG datasets in R
with <a href="https://github.com/apache/arrow/" class="external-link">arrow</a> and <a href="https://joelnitta.github.io/mtgr/" class="external-link">mtgr</a>.</p>
<p>The analysis I demonstrated here was obviously not anything new, but
I hope the methods explained in the vignette help you generate new
insights with your own analyses.</p>
<p>Enjoy!</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Joel H. Nitta.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
